/**
 * @version 1.2.1
 * Color.js - Palette and Color management for Director Assets
 * 
 * Provides reference implementations of the standard Adobe Director 
 * system palettes (Macintosh System 7, Windows 3.1/95) and grayscale 
 * gradients. Crucial for accurate bitmap reconstruction when no internal 
 * palette is defined.
 */

const PALETTES = {
    MAC: [
        [255, 255, 255], [255, 255, 204], [255, 255, 153], [255, 255, 102], [255, 255, 51], [255, 255, 0], [255, 204, 255], [255, 204, 204], [255, 204, 153], [255, 204, 102], [255, 204, 51], [255, 204, 0], [255, 153, 255], [255, 153, 204], [255, 153, 153], [255, 153, 102],
        [255, 153, 51], [255, 153, 0], [255, 102, 255], [255, 102, 204], [255, 102, 153], [255, 102, 102], [255, 102, 51], [255, 102, 0], [255, 51, 255], [255, 51, 204], [255, 51, 153], [255, 51, 102], [255, 51, 51], [255, 51, 0], [255, 0, 255], [255, 0, 204],
        [255, 0, 153], [255, 0, 102], [255, 0, 51], [255, 0, 0], [204, 255, 255], [204, 255, 204], [204, 255, 153], [204, 255, 102], [204, 255, 51], [204, 255, 0], [204, 204, 255], [204, 204, 204], [204, 204, 153], [204, 204, 102], [204, 204, 51], [204, 204, 0],
        [204, 153, 255], [204, 153, 204], [204, 153, 153], [204, 153, 102], [204, 153, 51], [204, 153, 0], [204, 102, 255], [204, 102, 204], [204, 102, 153], [204, 102, 102], [204, 102, 51], [204, 102, 0], [204, 51, 255], [204, 51, 204], [204, 51, 153], [204, 51, 102],
        [204, 51, 51], [204, 51, 0], [204, 0, 255], [204, 0, 204], [204, 0, 153], [204, 0, 102], [204, 0, 51], [204, 0, 0], [153, 255, 255], [153, 255, 204], [153, 255, 153], [153, 255, 102], [153, 255, 51], [153, 255, 0], [153, 204, 255], [153, 204, 204],
        [153, 204, 153], [153, 204, 102], [153, 204, 51], [153, 204, 0], [153, 153, 255], [153, 153, 204], [153, 153, 153], [153, 153, 102], [153, 153, 51], [153, 153, 0], [153, 102, 255], [153, 102, 204], [153, 102, 153], [153, 102, 102], [153, 102, 51], [153, 102, 0],
        [153, 51, 255], [153, 51, 204], [153, 51, 153], [153, 51, 102], [153, 51, 51], [153, 51, 0], [153, 0, 255], [153, 0, 204], [153, 0, 153], [153, 0, 102], [153, 0, 51], [153, 0, 0], [102, 255, 255], [102, 255, 204], [102, 255, 153], [102, 255, 66],
        [102, 255, 51], [102, 255, 0], [102, 204, 255], [102, 204, 204], [102, 204, 153], [102, 204, 102], [102, 204, 51], [102, 204, 0], [102, 153, 255], [102, 153, 204], [102, 153, 153], [102, 153, 102], [102, 153, 51], [102, 153, 0], [102, 102, 255], [102, 102, 204],
        [102, 102, 153], [102, 102, 102], [102, 102, 51], [102, 102, 0], [102, 51, 255], [102, 51, 204], [102, 51, 153], [102, 51, 102], [102, 51, 51], [102, 51, 0], [102, 0, 255], [102, 0, 204], [102, 0, 153], [102, 0, 102], [102, 0, 51], [102, 0, 0],
        [51, 255, 255], [51, 255, 204], [51, 255, 153], [51, 255, 102], [51, 255, 51], [51, 255, 0], [51, 204, 255], [51, 204, 204], [51, 204, 153], [51, 204, 102], [51, 204, 51], [51, 204, 0], [51, 153, 255], [51, 153, 204], [51, 153, 153], [51, 153, 102],
        [51, 153, 51], [51, 153, 0], [51, 102, 255], [51, 102, 204], [51, 102, 153], [51, 102, 102], [51, 102, 51], [51, 102, 0], [51, 51, 255], [51, 51, 204], [51, 51, 153], [51, 51, 102], [51, 51, 51], [51, 51, 0], [51, 0, 255], [51, 0, 204],
        [51, 0, 153], [51, 0, 102], [51, 0, 51], [51, 0, 0], [0, 255, 255], [0, 255, 204], [0, 255, 153], [0, 255, 102], [0, 255, 51], [0, 255, 0], [0, 204, 255], [0, 204, 204], [0, 204, 153], [0, 204, 102], [0, 204, 51], [0, 204, 0],
        [0, 153, 255], [0, 153, 204], [0, 153, 153], [0, 153, 102], [0, 153, 51], [0, 153, 0], [0, 102, 255], [0, 102, 204], [0, 102, 153], [0, 102, 102], [0, 102, 51], [0, 102, 0], [0, 51, 255], [0, 51, 204], [0, 51, 153], [0, 51, 102],
        [0, 51, 51], [0, 51, 0], [0, 0, 255], [0, 0, 204], [0, 0, 153], [0, 0, 102], [0, 0, 51], [238, 0, 0], [221, 0, 0], [187, 0, 0], [170, 0, 0], [136, 0, 0], [119, 0, 0], [85, 0, 0], [68, 0, 0], [34, 0, 0],
        [17, 0, 0], [0, 238, 0], [0, 221, 0], [0, 187, 0], [0, 170, 0], [0, 136, 0], [0, 119, 0], [0, 85, 0], [0, 68, 0], [0, 34, 0], [0, 17, 0], [0, 0, 238], [0, 0, 221], [0, 0, 187], [0, 0, 170], [0, 0, 136],
        [0, 0, 119], [0, 0, 85], [0, 0, 68], [0, 0, 34], [0, 0, 17], [238, 238, 238], [221, 221, 221], [187, 187, 187], [170, 170, 170], [136, 136, 136], [119, 119, 119], [85, 85, 85], [68, 68, 68], [34, 34, 34], [17, 17, 17], [0, 0, 0]
    ],
    WIN: [
        [255, 255, 255], [0, 255, 255], [255, 0, 255], [0, 0, 255], [255, 255, 0], [0, 255, 0], [255, 0, 0], [128, 128, 128], [160, 160, 164], [255, 251, 240], [51, 51, 51], [153, 102, 0], [51, 102, 51], [0, 51, 153], [204, 0, 255], [136, 0, 0],
        [255, 204, 102], [255, 153, 204], [221, 221, 221], [255, 153, 0], [255, 102, 255], [255, 102, 204], [255, 102, 153], [255, 102, 102], [255, 102, 51], [255, 102, 0], [255, 51, 255], [255, 51, 204], [255, 51, 153], [255, 51, 102], [255, 51, 51], [255, 51, 0],
        [255, 0, 204], [255, 0, 153], [255, 0, 102], [255, 0, 51], [204, 255, 255], [204, 255, 204], [204, 255, 153], [204, 255, 102], [204, 255, 51], [204, 255, 0], [204, 204, 255], [204, 204, 204], [204, 204, 153], [204, 204, 102], [204, 204, 51], [204, 204, 0],
        [204, 153, 255], [204, 153, 204], [204, 153, 153], [204, 153, 102], [204, 153, 51], [204, 153, 0], [204, 102, 255], [204, 102, 204], [204, 102, 153], [204, 102, 102], [204, 102, 51], [204, 102, 0], [204, 51, 255], [204, 51, 204], [204, 51, 153], [204, 51, 102],
        [204, 51, 51], [204, 51, 0], [212, 8, 255], [204, 0, 204], [204, 0, 153], [204, 0, 102], [204, 0, 51], [204, 0, 0], [153, 255, 255], [153, 255, 204], [153, 255, 153], [153, 255, 102], [153, 255, 51], [153, 255, 0], [153, 204, 255], [153, 204, 204],
        [153, 204, 153], [153, 204, 102], [153, 204, 51], [153, 204, 0], [153, 153, 255], [153, 153, 204], [153, 153, 153], [153, 153, 102], [153, 153, 51], [153, 153, 0], [153, 102, 255], [153, 102, 204], [153, 102, 153], [153, 102, 102], [153, 102, 51], [161, 102, 0],
        [153, 51, 255], [153, 51, 204], [153, 51, 153], [153, 51, 102], [153, 51, 51], [153, 51, 0], [153, 0, 255], [153, 0, 204], [153, 0, 153], [153, 0, 102], [153, 0, 51], [153, 0, 0], [102, 255, 255], [102, 255, 204], [102, 255, 153], [102, 255, 102],
        [102, 255, 51], [102, 255, 0], [102, 204, 255], [102, 204, 204], [102, 204, 153], [102, 204, 102], [102, 204, 51], [102, 204, 0], [102, 153, 255], [102, 153, 204], [102, 153, 153], [102, 153, 102], [102, 153, 51], [102, 153, 0], [102, 102, 255], [102, 102, 204],
        [102, 102, 153], [102, 102, 102], [102, 102, 51], [102, 102, 0], [102, 51, 255], [102, 51, 204], [102, 51, 153], [102, 51, 102], [102, 51, 51], [102, 51, 0], [102, 0, 255], [102, 0, 204], [102, 0, 153], [102, 0, 102], [102, 0, 51], [102, 0, 0],
        [51, 255, 255], [51, 255, 204], [51, 255, 153], [51, 255, 102], [51, 255, 51], [51, 255, 0], [51, 204, 255], [51, 204, 204], [51, 204, 153], [51, 204, 102], [51, 204, 51], [51, 204, 0], [51, 153, 255], [51, 153, 204], [51, 153, 153], [51, 153, 102],
        [51, 153, 51], [51, 153, 0], [51, 102, 255], [51, 102, 204], [51, 102, 153], [51, 102, 102], [51, 110, 51], [51, 102, 0], [51, 33, 255], [51, 33, 204], [51, 33, 153], [51, 33, 102], [51, 33, 59], [51, 33, 0], [51, 0, 255], [51, 0, 204],
        [51, 0, 153], [51, 0, 102], [51, 0, 51], [51, 0, 0], [0, 255, 204], [0, 255, 153], [0, 255, 102], [0, 255, 51], [0, 204, 255], [0, 204, 204], [0, 204, 153], [0, 204, 102], [0, 204, 51], [0, 204, 0], [0, 153, 255], [0, 153, 204],
        [0, 153, 153], [0, 153, 102], [0, 153, 51], [0, 153, 0], [0, 102, 255], [0, 102, 204], [0, 102, 153], [0, 102, 102], [0, 102, 51], [0, 102, 0], [0, 51, 255], [0, 51, 204], [0, 51, 161], [0, 51, 102], [0, 51, 83], [0, 51, 0],
        [0, 0, 204], [0, 0, 153], [0, 0, 102], [0, 0, 51], [238, 0, 0], [221, 0, 0], [170, 0, 0], [144, 0, 0], [119, 0, 0], [85, 0, 0], [68, 0, 0], [34, 0, 0], [17, 0, 0], [0, 238, 0], [0, 221, 0], [0, 170, 0],
        [0, 136, 0], [0, 119, 0], [0, 85, 0], [0, 68, 0], [0, 34, 0], [0, 17, 0], [0, 0, 238], [0, 0, 221], [0, 0, 170], [0, 0, 136], [0, 0, 119], [0, 0, 85], [0, 0, 68], [0, 0, 34], [0, 0, 17], [34, 34, 48],
        [255, 153, 153], [255, 204, 255], [153, 212, 255], [153, 212, 153], [255, 255, 153], [240, 240, 240], [166, 202, 240], [192, 220, 192], [192, 192, 192], [0, 128, 128], [128, 0, 128], [0, 0, 128], [128, 128, 0], [0, 128, 0], [128, 0, 0], [0, 0, 0]
    ],
    GRAY: Array.from({ length: 256 }, (_, i) => [255 - i, 255 - i, 255 - i])
};

class Color {
    /**
     * Parses a raw CLUT palette. Supports multiple formats:
     * - 768 bytes: 8-bit RGB (3 bytes per entry)
     * - 1024 bytes: 8-bit RGB + Alpha/Skip (4 bytes per entry)
     * - 1536 bytes: 16-bit RGB (6 bytes per entry, divide by 256)
     */
    static parseDirector(buffer) {
        if (!buffer) return PALETTES.MAC;

        const palette = [];
        const len = buffer.length;

        if (len >= 1536) { // 16-bit RGB (6 bytes per entry)
            for (let i = 0; i < 256; i++) {
                const offset = i * 6;
                const r = buffer.readUInt16BE(offset);
                const g = buffer.readUInt16BE(offset + 2);
                const b = buffer.readUInt16BE(offset + 4);
                palette.push([r >> 8, g >> 8, b >> 8]);
            }
        } else if (len >= 1024) { // 8-bit RGB + Skip (4 bytes per entry)
            for (let i = 0; i < 256; i++) {
                const offset = i * 4;
                palette.push([buffer[offset], buffer[offset + 1], buffer[offset + 2]]);
            }
        } else if (len >= 768) { // 8-bit RGB (3 bytes per entry)
            for (let i = 0; i < 256; i++) {
                const offset = i * 3;
                palette.push([buffer[offset], buffer[offset + 1], buffer[offset + 2]]);
            }
        } else {
            return PALETTES.MAC;
        }

        return palette;
    }

    static getMacSystem7() { return PALETTES.MAC; }
    static getWindowsSystem() { return PALETTES.WIN; }
    static getGrayscale() { return PALETTES.GRAY; }

    /**
     * Resolves a palette index to a hex color string.
     * @param {number} index 
     * @param {Array} palette 
     */
    static resolve(index, palette = null) {
        const pal = palette || PALETTES.MAC;
        const rgb = (index >= 0 && index < pal.length) ? pal[index] : [0, 0, 0];
        return this.toHex(rgb);
    }

    /**
     * Converts RGB array to standardized Hex string.
     */
    static toHex(rgb) {
        if (!rgb || rgb.length < 3) return '#000000';
        return '#' + rgb.map(c => c.toString(16).padStart(2, '0')).join('');
    }
}

module.exports = Color;
