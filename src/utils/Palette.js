const path = require('path');
const { Magic } = require('../Constants');
const DirectorFile = require('../DirectorFile');

const PALETTES = {
    MAC: [
        [255, 255, 255], [255, 255, 204], [255, 255, 153], [255, 255, 102], [255, 255, 51], [255, 255, 0], [255, 204, 255], [255, 204, 204],
        [255, 204, 153], [255, 204, 102], [255, 204, 51], [255, 204, 0], [255, 153, 255], [255, 153, 204], [255, 153, 153], [255, 153, 102],
        [255, 153, 51], [255, 153, 0], [255, 102, 255], [255, 102, 204], [255, 102, 153], [255, 102, 102], [255, 102, 51], [255, 102, 0],
        [255, 51, 255], [255, 51, 204], [255, 51, 153], [255, 51, 102], [255, 51, 51], [255, 51, 0], [255, 0, 255], [255, 0, 204],
        [255, 0, 153], [255, 0, 102], [255, 0, 51], [255, 0, 0], [204, 255, 255], [204, 255, 204], [204, 255, 153], [204, 255, 102],
        [204, 255, 51], [204, 255, 0], [204, 204, 255], [204, 204, 204], [204, 204, 153], [204, 204, 102], [204, 204, 51], [204, 204, 0],
        [204, 153, 255], [204, 153, 204], [204, 153, 153], [204, 153, 102], [204, 153, 51], [204, 153, 0], [204, 102, 255], [204, 102, 204],
        [204, 102, 153], [204, 102, 102], [204, 102, 51], [204, 102, 0], [204, 51, 255], [204, 51, 204], [204, 51, 153], [204, 51, 102],
        [204, 51, 51], [204, 51, 0], [204, 0, 255], [204, 0, 204], [204, 0, 153], [204, 0, 102], [204, 0, 51], [204, 0, 0],
        [153, 255, 255], [153, 255, 204], [153, 255, 153], [153, 255, 102], [153, 255, 51], [153, 255, 0], [153, 204, 255], [153, 204, 204],
        [153, 204, 153], [153, 204, 102], [153, 204, 51], [153, 204, 0], [153, 153, 255], [153, 153, 204], [153, 153, 153], [153, 153, 102],
        [153, 153, 51], [153, 153, 0], [153, 102, 255], [153, 102, 204], [153, 102, 153], [153, 102, 102], [153, 102, 51], [153, 102, 0],
        [153, 51, 255], [153, 51, 204], [153, 51, 153], [153, 51, 102], [153, 51, 51], [153, 51, 0], [153, 0, 255], [153, 0, 204],
        [153, 0, 153], [153, 0, 102], [153, 0, 51], [153, 0, 0], [102, 255, 255], [102, 255, 204], [102, 255, 153], [102, 255, 102],
        [102, 255, 51], [102, 255, 0], [102, 204, 255], [102, 204, 204], [102, 204, 153], [102, 204, 102], [102, 204, 51], [102, 204, 0],
        [102, 153, 255], [102, 153, 204], [102, 153, 153], [102, 153, 102], [102, 153, 51], [102, 153, 0], [102, 102, 255], [102, 102, 204],
        [102, 102, 153], [102, 102, 102], [102, 102, 51], [102, 102, 0], [102, 51, 255], [102, 51, 204], [102, 51, 153], [102, 51, 102],
        [102, 51, 51], [102, 51, 0], [102, 0, 255], [102, 0, 204], [102, 0, 153], [102, 0, 102], [102, 0, 51], [102, 0, 0],
        [51, 255, 255], [51, 255, 204], [51, 255, 153], [51, 255, 102], [51, 255, 51], [51, 255, 0], [51, 204, 255], [51, 204, 204],
        [51, 204, 153], [51, 204, 102], [51, 204, 51], [51, 204, 0], [51, 153, 255], [51, 153, 204], [51, 153, 153], [51, 153, 102],
        [51, 153, 51], [51, 153, 0], [51, 102, 255], [51, 102, 204], [51, 102, 153], [51, 102, 102], [51, 102, 51], [51, 102, 0],
        [51, 51, 255], [51, 51, 204], [51, 51, 153], [51, 51, 102], [51, 51, 51], [51, 51, 0], [51, 0, 255], [51, 0, 204],
        [51, 0, 153], [51, 0, 102], [51, 0, 51], [51, 0, 0], [0, 255, 255], [0, 255, 204], [0, 255, 153], [0, 255, 102],
        [0, 255, 51], [0, 255, 0], [0, 204, 255], [0, 204, 204], [0, 204, 153], [0, 204, 102], [0, 204, 51], [0, 204, 0],
        [0, 153, 255], [0, 153, 204], [0, 153, 153], [0, 153, 102], [0, 153, 51], [0, 153, 0], [0, 102, 255], [0, 102, 204],
        [0, 102, 153], [0, 102, 102], [0, 102, 51], [0, 102, 0], [0, 51, 255], [0, 51, 204], [0, 51, 153], [0, 51, 102],
        [0, 51, 51], [0, 51, 0], [0, 0, 255], [0, 0, 204], [0, 0, 153], [0, 0, 102], [0, 0, 51], [238, 0, 0],
        [221, 0, 0], [187, 0, 0], [170, 0, 0], [136, 0, 0], [119, 0, 0], [85, 0, 0], [68, 0, 0], [34, 0, 0],
        [17, 0, 0], [0, 238, 0], [0, 221, 0], [0, 187, 0], [0, 170, 0], [0, 136, 0], [0, 119, 0], [0, 85, 0],
        [0, 68, 0], [0, 34, 0], [0, 17, 0], [0, 0, 238], [0, 0, 221], [0, 0, 187], [0, 0, 170], [0, 0, 136],
        [0, 0, 119], [0, 0, 85], [0, 0, 68], [0, 0, 34], [0, 0, 17], [238, 238, 238], [221, 221, 221], [187, 187, 187],
        [170, 170, 170], [136, 136, 136], [119, 119, 119], [85, 85, 85], [68, 68, 68], [34, 34, 34], [17, 17, 17], [0, 0, 0]
    ],
    WIN: [
        [255, 255, 255], [0, 255, 255], [255, 0, 255], [0, 0, 255], [255, 255, 0], [0, 255, 0], [255, 0, 0], [128, 128, 128],
        [160, 160, 164], [255, 251, 240], [51, 51, 51], [153, 102, 0], [51, 102, 51], [0, 51, 153], [204, 0, 255], [136, 0, 0],
        [255, 204, 102], [255, 153, 204], [221, 221, 221], [255, 153, 0], [255, 102, 255], [255, 102, 204], [255, 102, 153], [255, 102, 102],
        [255, 102, 51], [255, 102, 0], [255, 51, 255], [255, 51, 204], [255, 51, 153], [255, 51, 102], [255, 51, 51], [255, 51, 0],
        [255, 0, 204], [255, 0, 153], [255, 0, 102], [255, 0, 51], [204, 255, 255], [204, 255, 204], [204, 255, 153], [204, 255, 102],
        [204, 255, 51], [204, 255, 0], [204, 204, 255], [204, 204, 204], [204, 204, 153], [204, 204, 102], [204, 204, 51], [204, 204, 0],
        [204, 153, 255], [204, 153, 204], [204, 153, 153], [204, 153, 102], [204, 153, 51], [204, 153, 0], [204, 102, 255], [204, 102, 204],
        [204, 102, 153], [204, 102, 102], [204, 102, 51], [204, 102, 0], [204, 51, 255], [204, 51, 204], [204, 51, 153], [204, 51, 102],
        [204, 51, 51], [204, 51, 0], [212, 8, 255], [204, 0, 204], [204, 0, 153], [204, 0, 102], [204, 0, 51], [204, 0, 0],
        [153, 255, 255], [153, 255, 204], [153, 255, 153], [153, 255, 102], [153, 255, 51], [153, 255, 0], [153, 204, 255], [153, 204, 204],
        [153, 204, 153], [153, 204, 102], [153, 204, 51], [153, 204, 0], [153, 153, 255], [153, 153, 204], [153, 153, 153], [153, 153, 102],
        [153, 153, 51], [153, 153, 0], [153, 102, 255], [153, 102, 204], [153, 102, 153], [153, 102, 102], [153, 102, 51], [161, 102, 0],
        [153, 51, 255], [153, 51, 204], [153, 51, 153], [153, 51, 102], [153, 51, 51], [153, 51, 0], [153, 0, 255], [153, 0, 204],
        [153, 0, 153], [153, 0, 102], [153, 0, 51], [153, 0, 0], [102, 255, 255], [102, 255, 204], [102, 255, 153], [102, 255, 102],
        [102, 255, 51], [102, 255, 0], [102, 204, 255], [102, 204, 204], [102, 204, 153], [102, 204, 102], [102, 204, 51], [102, 204, 0],
        [102, 153, 255], [102, 153, 204], [102, 153, 153], [102, 153, 102], [102, 153, 51], [102, 153, 0], [102, 102, 255], [102, 102, 204],
        [102, 102, 153], [102, 102, 102], [102, 102, 51], [102, 102, 0], [102, 51, 255], [102, 51, 204], [102, 51, 153], [102, 51, 102],
        [102, 51, 51], [102, 51, 0], [102, 0, 255], [102, 0, 204], [102, 0, 153], [102, 0, 102], [102, 0, 51], [102, 0, 0],
        [51, 255, 255], [51, 255, 204], [51, 255, 153], [51, 255, 102], [51, 255, 51], [51, 255, 0], [51, 204, 255], [51, 204, 204],
        [51, 204, 153], [51, 204, 102], [51, 204, 51], [51, 204, 0], [51, 153, 255], [51, 153, 204], [51, 153, 153], [51, 153, 102],
        [51, 153, 51], [51, 153, 0], [51, 102, 255], [51, 102, 204], [51, 102, 153], [51, 102, 102], [51, 110, 51], [51, 102, 0],
        [51, 51, 255], [51, 51, 204], [51, 51, 153], [51, 51, 102], [51, 51, 59], [51, 51, 0], [51, 0, 255], [51, 0, 204],
        [51, 0, 153], [51, 0, 102], [51, 0, 51], [51, 0, 0], [0, 255, 204], [0, 255, 153], [0, 255, 102], [0, 255, 51],
        [0, 204, 255], [0, 204, 204], [0, 204, 153], [0, 204, 102], [0, 204, 51], [0, 204, 0], [0, 153, 255], [0, 153, 204],
        [0, 153, 153], [0, 153, 102], [0, 153, 51], [0, 153, 0], [0, 102, 255], [0, 102, 204], [0, 102, 153], [0, 102, 102],
        [0, 102, 51], [0, 102, 0], [0, 51, 255], [0, 51, 204], [0, 51, 161], [0, 51, 102], [0, 51, 51], [0, 51, 0],
        [0, 0, 204], [0, 0, 153], [0, 0, 102], [0, 0, 51], [238, 0, 0], [221, 0, 0], [170, 0, 0], [144, 0, 0],
        [119, 0, 0], [85, 0, 0], [68, 0, 0], [34, 0, 0], [17, 0, 0], [0, 238, 0], [0, 221, 0], [0, 170, 0],
        [0, 136, 0], [0, 119, 0], [0, 85, 0], [0, 68, 0], [0, 34, 0], [0, 17, 0], [0, 0, 238], [0, 0, 221],
        [0, 0, 170], [0, 0, 136], [0, 0, 119], [0, 0, 85], [0, 0, 68], [0, 0, 34], [0, 0, 17], [34, 34, 48],
        [255, 153, 153], [255, 204, 255], [153, 212, 255], [153, 212, 153], [255, 255, 153], [240, 240, 240], [164, 200, 240], [192, 220, 192],
        [192, 192, 192], [0, 191, 191], [191, 0, 191], [0, 0, 191], [191, 191, 0], [0, 191, 0], [191, 0, 0], [0, 0, 0]
    ],
    RAINBOW: [
        [255, 255, 255], [0, 105, 255], [0, 99, 255], [0, 93, 255], [0, 86, 255], [0, 80, 255], [0, 74, 255], [0, 67, 255],
        [0, 61, 255], [0, 54, 255], [0, 48, 255], [0, 42, 255], [0, 35, 255], [0, 29, 255], [0, 23, 255], [0, 16, 255],
        [0, 10, 255], [0, 3, 255], [6, 0, 255], [12, 0, 255], [19, 0, 255], [25, 0, 255], [31, 0, 255], [38, 0, 255],
        [44, 0, 255], [51, 0, 255], [57, 0, 255], [63, 0, 255], [70, 0, 255], [76, 0, 255], [82, 0, 255], [89, 0, 255],
        [95, 0, 255], [102, 0, 255], [108, 0, 255], [114, 0, 255], [121, 0, 255], [127, 0, 255], [133, 0, 255], [140, 0, 255],
        [146, 0, 255], [153, 0, 255], [159, 0, 255], [165, 0, 255], [172, 0, 255], [178, 0, 255], [184, 0, 255], [191, 0, 255],
        [197, 0, 255], [204, 0, 255], [210, 0, 255], [216, 0, 255], [223, 0, 255], [229, 0, 255], [235, 0, 255], [242, 0, 255],
        [248, 0, 255], [255, 0, 255], [255, 0, 248], [255, 0, 242], [255, 0, 235], [255, 0, 229], [255, 0, 223], [255, 0, 216],
        [255, 0, 210], [255, 0, 204], [255, 0, 197], [255, 0, 191], [255, 0, 184], [255, 0, 178], [255, 0, 172], [255, 0, 165],
        [255, 0, 159], [255, 0, 153], [255, 0, 146], [255, 0, 140], [255, 0, 133], [255, 0, 127], [255, 0, 121], [255, 0, 114],
        [255, 0, 108], [255, 0, 102], [255, 0, 95], [255, 0, 89], [255, 0, 82], [255, 0, 76], [255, 0, 70], [255, 0, 63],
        [255, 0, 57], [255, 0, 51], [255, 0, 44], [255, 0, 38], [255, 0, 31], [255, 0, 25], [255, 0, 19], [255, 0, 12],
        [255, 0, 6], [255, 0, 0], [255, 6, 0], [255, 12, 0], [255, 19, 0], [255, 25, 0], [255, 31, 0], [255, 38, 0],
        [255, 44, 0], [255, 51, 0], [255, 57, 0], [255, 63, 0], [255, 70, 0], [255, 76, 0], [255, 82, 0], [255, 89, 0],
        [255, 95, 0], [255, 102, 0], [255, 108, 0], [255, 114, 0], [255, 121, 0], [255, 127, 0], [255, 133, 0], [255, 140, 0],
        [255, 146, 0], [255, 153, 0], [255, 159, 0], [255, 165, 0], [255, 172, 0], [255, 178, 0], [255, 184, 0], [255, 191, 0],
        [255, 197, 0], [255, 204, 0], [255, 210, 0], [255, 216, 0], [255, 223, 0], [255, 229, 0], [255, 235, 0], [255, 242, 0],
        [255, 248, 0], [255, 255, 0], [248, 255, 0], [242, 255, 0], [235, 255, 0], [229, 255, 0], [223, 255, 0], [216, 255, 0],
        [210, 255, 0], [204, 255, 0], [197, 255, 0], [191, 255, 0], [184, 255, 0], [178, 255, 0], [172, 255, 0], [165, 255, 0],
        [159, 255, 0], [153, 255, 0], [146, 255, 0], [140, 255, 0], [133, 255, 0], [127, 255, 0], [121, 255, 0], [114, 255, 0],
        [108, 255, 0], [102, 255, 0], [95, 255, 0], [89, 255, 0], [82, 255, 0], [76, 255, 0], [70, 255, 0], [63, 255, 0],
        [57, 255, 0], [51, 255, 0], [44, 255, 0], [38, 255, 0], [31, 255, 0], [25, 255, 0], [19, 255, 0], [12, 255, 0],
        [6, 255, 0], [0, 255, 0], [0, 255, 6], [0, 255, 12], [0, 255, 19], [0, 255, 25], [0, 255, 31], [0, 255, 38],
        [0, 255, 44], [0, 255, 51], [0, 255, 57], [0, 255, 63], [0, 255, 70], [0, 255, 76], [0, 255, 82], [0, 255, 89],
        [0, 255, 95], [0, 255, 102], [0, 255, 108], [0, 255, 114], [0, 255, 121], [0, 255, 127], [0, 255, 133], [0, 255, 140],
        [0, 255, 146], [0, 255, 153], [0, 255, 159], [0, 255, 165], [0, 255, 172], [0, 255, 178], [0, 255, 184], [0, 255, 191],
        [0, 255, 197], [0, 255, 204], [0, 255, 210], [0, 255, 216], [0, 255, 223], [0, 255, 229], [0, 255, 235], [0, 255, 242],
        [0, 255, 248], [0, 255, 255], [0, 248, 255], [0, 242, 255], [0, 235, 255], [0, 229, 255], [0, 223, 255], [0, 216, 255],
        [0, 210, 255], [0, 204, 255], [0, 197, 255], [0, 191, 255], [0, 184, 255], [0, 178, 255], [0, 172, 255], [0, 165, 255],
        [0, 159, 255], [0, 153, 255], [0, 146, 255], [0, 140, 255], [0, 133, 255], [0, 127, 255], [0, 121, 255], [0, 114, 255],
        [240, 240, 240], [224, 224, 224], [208, 208, 208], [192, 192, 192], [176, 176, 176], [160, 160, 160], [144, 144, 144], [128, 128, 128],
        [112, 112, 112], [96, 96, 96], [80, 80, 80], [64, 64, 64], [48, 48, 48], [32, 32, 32], [16, 16, 16], [0, 0, 0]
    ],
    GRAYSCALE: [
        [255, 255, 255], [254, 254, 254], [253, 253, 253], [252, 252, 252], [251, 251, 251], [250, 250, 250], [249, 249, 249], [248, 248, 248],
        [247, 247, 247], [246, 246, 246], [245, 245, 245], [244, 244, 244], [243, 243, 243], [242, 242, 242], [241, 241, 241], [240, 240, 240],
        [239, 239, 239], [238, 238, 238], [237, 237, 237], [236, 236, 236], [235, 235, 235], [234, 234, 234], [233, 233, 233], [232, 232, 232],
        [231, 231, 231], [230, 230, 230], [229, 229, 229], [228, 228, 228], [227, 227, 227], [226, 226, 226], [225, 225, 225], [224, 224, 224],
        [223, 223, 223], [222, 222, 222], [221, 221, 221], [220, 220, 220], [219, 219, 219], [218, 218, 218], [217, 217, 217], [216, 216, 216],
        [215, 215, 215], [214, 214, 214], [213, 213, 213], [212, 212, 212], [211, 211, 211], [210, 210, 210], [209, 209, 209], [208, 208, 208],
        [207, 207, 207], [206, 206, 206], [205, 205, 205], [204, 204, 204], [203, 203, 203], [202, 202, 202], [201, 201, 201], [200, 200, 200],
        [199, 199, 199], [198, 198, 198], [197, 197, 197], [196, 196, 196], [195, 195, 195], [194, 194, 194], [193, 193, 193], [192, 192, 192],
        [191, 191, 191], [190, 190, 190], [189, 189, 189], [188, 188, 188], [187, 187, 187], [186, 186, 186], [185, 185, 185], [184, 184, 184],
        [183, 183, 183], [182, 182, 182], [181, 181, 181], [180, 180, 180], [179, 179, 179], [178, 178, 178], [177, 177, 177], [176, 176, 176],
        [175, 175, 175], [174, 174, 174], [173, 173, 173], [172, 172, 172], [171, 171, 171], [170, 170, 170], [169, 169, 169], [168, 168, 168],
        [167, 167, 167], [166, 166, 166], [165, 165, 165], [164, 164, 164], [163, 163, 163], [162, 162, 162], [161, 161, 161], [160, 160, 160],
        [159, 159, 159], [158, 158, 158], [157, 157, 157], [156, 156, 156], [155, 155, 155], [154, 154, 154], [153, 153, 153], [152, 152, 152],
        [151, 151, 151], [150, 150, 150], [149, 149, 149], [148, 148, 148], [147, 147, 147], [146, 146, 146], [145, 145, 145], [144, 144, 144],
        [143, 143, 143], [142, 142, 142], [141, 141, 141], [140, 140, 140], [139, 139, 139], [138, 138, 138], [137, 137, 137], [136, 136, 136],
        [135, 135, 135], [134, 134, 134], [133, 133, 133], [132, 132, 132], [131, 131, 131], [130, 130, 130], [129, 129, 129], [128, 128, 128],
        [127, 127, 127], [126, 126, 126], [125, 125, 125], [124, 124, 124], [123, 123, 123], [122, 122, 122], [121, 121, 121], [120, 120, 120],
        [119, 119, 119], [118, 118, 118], [117, 117, 117], [116, 116, 116], [115, 115, 115], [114, 114, 114], [113, 113, 113], [112, 112, 112],
        [111, 111, 111], [110, 110, 110], [109, 109, 109], [108, 108, 108], [107, 107, 107], [106, 106, 106], [105, 105, 105], [104, 104, 104],
        [103, 103, 103], [102, 102, 102], [101, 101, 101], [100, 100, 100], [99, 99, 99], [98, 98, 98], [97, 97, 97], [96, 96, 96],
        [95, 95, 95], [94, 94, 94], [93, 93, 93], [92, 92, 92], [91, 91, 91], [90, 90, 90], [89, 89, 89], [88, 88, 88],
        [87, 87, 87], [86, 86, 86], [85, 85, 85], [84, 84, 84], [83, 83, 83], [82, 82, 82], [81, 81, 81], [80, 80, 80],
        [79, 79, 79], [78, 78, 78], [77, 77, 77], [76, 76, 76], [75, 75, 75], [74, 74, 74], [73, 73, 73], [72, 72, 72],
        [71, 71, 71], [70, 70, 70], [69, 69, 69], [68, 68, 68], [67, 67, 67], [66, 66, 66], [65, 65, 65], [64, 64, 64],
        [63, 63, 63], [62, 62, 62], [61, 61, 61], [60, 60, 60], [59, 59, 59], [58, 58, 58], [57, 57, 57], [56, 56, 56],
        [55, 55, 55], [54, 54, 54], [53, 53, 53], [52, 52, 52], [51, 51, 51], [50, 50, 50], [49, 49, 49], [48, 48, 48],
        [47, 47, 47], [46, 46, 46], [45, 45, 45], [44, 44, 44], [43, 43, 43], [42, 42, 42], [41, 41, 41], [40, 40, 40],
        [39, 39, 39], [38, 38, 38], [37, 37, 37], [36, 36, 36], [35, 35, 35], [34, 34, 34], [33, 33, 33], [32, 32, 32],
        [31, 31, 31], [30, 30, 30], [29, 29, 29], [28, 28, 28], [27, 27, 27], [26, 26, 26], [25, 25, 25], [24, 24, 24],
        [23, 23, 23], [22, 22, 22], [21, 21, 21], [20, 20, 20], [19, 19, 19], [18, 18, 18], [17, 17, 17], [16, 16, 16],
        [15, 15, 15], [14, 14, 14], [13, 13, 13], [12, 12, 12], [11, 11, 11], [10, 10, 10], [9, 9, 9], [8, 8, 8],
        [7, 7, 7], [6, 6, 6], [5, 5, 5], [4, 4, 4], [3, 3, 3], [2, 2, 2], [1, 1, 1], [0, 0, 0]
    ],
    PASTELS: [
        [255, 255, 255], [254, 254, 242], [254, 253, 230], [254, 253, 218], [254, 252, 206], [254, 251, 194], [254, 251, 182], [254, 250, 170],
        [253, 250, 157], [253, 249, 145], [253, 248, 133], [253, 248, 121], [253, 247, 109], [253, 247, 97], [253, 246, 85], [252, 245, 72],
        [252, 238, 71], [252, 231, 71], [252, 224, 71], [252, 217, 71], [253, 210, 71], [253, 203, 71], [253, 196, 71], [253, 190, 71],
        [253, 183, 71], [254, 176, 71], [254, 169, 71], [254, 162, 71], [254, 155, 71], [254, 148, 71], [255, 141, 70], [253, 136, 70],
        [251, 132, 70], [249, 127, 70], [248, 123, 71], [246, 119, 71], [244, 114, 71], [243, 110, 71], [241, 106, 72], [239, 101, 72],
        [238, 97, 72], [236, 93, 72], [234, 88, 73], [233, 84, 73], [231, 80, 73], [229, 75, 74], [226, 73, 73], [223, 71, 72],
        [220, 69, 72], [217, 67, 71], [214, 65, 71], [212, 63, 70], [209, 61, 70], [206, 59, 69], [203, 57, 69], [200, 55, 68],
        [198, 53, 68], [195, 51, 67], [192, 49, 67], [189, 47, 66], [186, 45, 65], [190, 47, 71], [194, 49, 78], [198, 51, 85],
        [202, 53, 91], [206, 55, 98], [210, 57, 105], [214, 59, 112], [218, 61, 118], [222, 63, 125], [226, 65, 132], [230, 67, 139],
        [234, 69, 145], [238, 71, 152], [242, 73, 159], [246, 75, 166], [237, 74, 167], [229, 74, 169], [220, 73, 170], [212, 73, 172],
        [204, 72, 173], [195, 72, 175], [187, 72, 176], [179, 71, 178], [170, 71, 179], [162, 70, 181], [154, 70, 182], [145, 70, 184],
        [137, 69, 185], [129, 69, 187], [120, 68, 189], [116, 68, 191], [113, 68, 193], [109, 68, 196], [106, 68, 198], [102, 68, 200],
        [99, 68, 203], [96, 68, 205], [92, 68, 207], [89, 68, 210], [85, 68, 212], [82, 68, 214], [79, 68, 217], [75, 68, 219],
        [72, 68, 221], [68, 69, 224], [68, 77, 225], [68, 85, 226], [68, 94, 227], [68, 102, 228], [69, 110, 229], [69, 119, 230],
        [69, 127, 231], [69, 135, 232], [69, 144, 233], [70, 152, 234], [70, 160, 235], [70, 169, 236], [70, 177, 237], [70, 185, 238],
        [71, 194, 240], [72, 194, 229], [73, 195, 219], [75, 195, 208], [76, 196, 198], [78, 197, 187], [79, 197, 177], [80, 198, 167],
        [82, 198, 156], [83, 199, 146], [85, 200, 135], [86, 200, 125], [87, 201, 115], [89, 201, 104], [90, 202, 94], [92, 203, 83],
        [90, 199, 82], [88, 195, 82], [87, 191, 82], [85, 187, 82], [84, 183, 82], [82, 179, 82], [81, 175, 82], [79, 171, 82],
        [78, 167, 82], [76, 163, 82], [75, 159, 82], [73, 155, 82], [72, 151, 82], [70, 147, 82], [68, 143, 81], [72, 140, 80],
        [76, 137, 79], [80, 134, 79], [85, 132, 78], [89, 129, 78], [93, 126, 77], [97, 123, 77], [102, 121, 76], [106, 118, 76],
        [110, 115, 75], [114, 112, 75], [119, 110, 74], [123, 107, 74], [127, 104, 73], [132, 101, 72], [140, 110, 72], [148, 120, 72],
        [156, 130, 72], [164, 139, 72], [172, 149, 72], [180, 159, 72], [188, 168, 72], [196, 178, 72], [204, 188, 72], [212, 197, 72],
        [220, 207, 72], [228, 217, 72], [236, 226, 72], [244, 236, 72], [253, 246, 73], [251, 234, 73], [249, 223, 73], [248, 211, 73],
        [246, 200, 73], [245, 189, 73], [243, 177, 73], [242, 166, 73], [240, 155, 73], [239, 143, 73], [237, 132, 73], [236, 121, 73],
        [234, 109, 73], [233, 98, 73], [231, 87, 73], [229, 75, 74], [230, 75, 80], [231, 75, 86], [232, 75, 92], [233, 75, 98],
        [234, 75, 104], [235, 75, 110], [236, 75, 116], [238, 75, 123], [239, 75, 129], [240, 75, 135], [241, 75, 141], [242, 75, 147],
        [243, 75, 153], [244, 75, 159], [246, 75, 166], [234, 74, 169], [222, 74, 173], [210, 73, 177], [198, 73, 181], [186, 72, 185],
        [175, 72, 189], [163, 72, 193], [151, 71, 196], [139, 71, 200], [127, 70, 204], [116, 70, 208], [104, 70, 212], [92, 69, 216],
        [80, 69, 220], [68, 68, 224], [79, 79, 225], [90, 90, 226], [102, 102, 227], [113, 113, 228], [125, 125, 229], [136, 136, 230],
        [148, 148, 231], [159, 159, 232], [171, 171, 233], [182, 182, 234], [194, 194, 235], [205, 205, 236], [217, 217, 237], [228, 228, 238],
        [240, 240, 240], [224, 224, 224], [208, 208, 208], [192, 192, 192], [176, 176, 176], [160, 160, 160], [144, 144, 144], [128, 128, 128],
        [112, 112, 112], [96, 96, 96], [80, 80, 80], [64, 64, 64], [48, 48, 48], [32, 32, 32], [16, 16, 16], [0, 0, 0]
    ],
    VIVID: [
        [255, 255, 255], [254, 254, 238], [254, 253, 221], [254, 252, 204], [254, 251, 188], [253, 250, 171], [253, 250, 154], [253, 249, 138],
        [253, 248, 121], [253, 247, 104], [252, 246, 88], [252, 246, 71], [252, 245, 54], [252, 244, 38], [252, 243, 21], [251, 242, 4],
        [251, 232, 3], [251, 223, 3], [251, 213, 3], [252, 204, 3], [252, 194, 3], [252, 185, 3], [252, 175, 3], [253, 166, 2],
        [253, 156, 2], [253, 147, 2], [253, 137, 2], [254, 128, 2], [254, 118, 2], [254, 109, 2], [255, 99, 1], [252, 92, 1],
        [250, 86, 1], [248, 80, 2], [245, 74, 2], [243, 68, 2], [241, 62, 3], [239, 56, 3], [236, 50, 3], [234, 44, 4],
        [232, 38, 4], [230, 32, 4], [227, 26, 5], [225, 20, 5], [223, 14, 5], [220, 7, 6], [216, 6, 7], [213, 6, 8],
        [210, 5, 9], [206, 5, 10], [203, 4, 12], [200, 4, 13], [197, 3, 14], [193, 3, 15], [190, 2, 16], [187, 2, 18],
        [184, 1, 19], [180, 1, 20], [177, 0, 21], [174, 0, 22], [170, 0, 24], [174, 0, 31], [179, 1, 38], [184, 1, 45],
        [189, 2, 52], [194, 2, 60], [198, 3, 67], [203, 3, 74], [208, 4, 81], [213, 4, 88], [218, 5, 96], [222, 5, 103],
        [227, 6, 110], [232, 6, 117], [237, 7, 124], [242, 8, 132], [230, 7, 134], [219, 6, 136], [207, 6, 138], [196, 5, 140],
        [184, 5, 143], [173, 4, 145], [161, 4, 147], [150, 3, 149], [138, 3, 151], [127, 2, 154], [115, 2, 156], [104, 1, 158],
        [92, 1, 160], [81, 0, 162], [69, 0, 165], [64, 0, 168], [59, 0, 171], [55, 0, 174], [50, 0, 177], [45, 0, 180],
        [41, 0, 183], [36, 0, 186], [32, 0, 190], [27, 0, 193], [22, 0, 196], [18, 0, 199], [13, 0, 202], [9, 0, 205],
        [4, 0, 208], [0, 0, 212], [0, 11, 213], [0, 22, 214], [0, 34, 216], [0, 45, 217], [0, 57, 219], [0, 68, 220],
        [0, 79, 222], [1, 91, 223], [1, 102, 225], [1, 114, 226], [1, 125, 228], [1, 136, 229], [1, 148, 231], [1, 159, 232],
        [2, 171, 234], [3, 171, 219], [5, 172, 205], [7, 173, 191], [9, 174, 176], [11, 175, 162], [13, 175, 148], [15, 176, 134],
        [17, 177, 119], [19, 178, 105], [21, 179, 91], [23, 179, 77], [25, 180, 62], [27, 181, 48], [29, 182, 34], [31, 183, 19],
        [28, 177, 18], [26, 171, 18], [24, 166, 18], [22, 160, 18], [20, 155, 18], [18, 149, 18], [16, 144, 18], [14, 138, 17],
        [12, 133, 17], [10, 127, 17], [8, 122, 17], [6, 116, 17], [4, 111, 17], [2, 105, 17], [0, 99, 16], [5, 95, 15],
        [11, 91, 14], [17, 87, 13], [22, 84, 13], [28, 80, 12], [34, 76, 11], [40, 73, 10], [45, 69, 10], [51, 65, 9],
        [57, 62, 8], [63, 58, 7], [68, 54, 7], [74, 51, 6], [80, 47, 5], [86, 43, 4], [97, 56, 4], [108, 69, 4],
        [119, 83, 4], [130, 96, 4], [141, 109, 4], [152, 123, 4], [163, 136, 4], [174, 149, 4], [185, 163, 4], [196, 176, 4],
        [207, 189, 4], [218, 203, 4], [229, 216, 4], [240, 229, 4], [252, 243, 5], [249, 227, 5], [247, 211, 5], [245, 195, 5],
        [243, 180, 5], [241, 164, 5], [239, 148, 5], [237, 133, 5], [235, 117, 5], [233, 101, 5], [231, 86, 5], [229, 70, 5],
        [227, 54, 5], [225, 39, 5], [223, 23, 5], [220, 7, 6], [221, 7, 14], [222, 7, 22], [224, 7, 31], [225, 7, 39],
        [227, 7, 48], [228, 7, 56], [230, 7, 64], [231, 7, 73], [233, 7, 81], [234, 7, 90], [236, 7, 98], [237, 7, 106],
        [239, 7, 115], [240, 7, 123], [242, 8, 132], [225, 7, 137], [209, 6, 142], [193, 6, 148], [177, 5, 153], [161, 5, 158],
        [145, 4, 164], [129, 4, 169], [112, 3, 174], [96, 3, 180], [80, 2, 185], [64, 2, 190], [48, 1, 196], [32, 1, 201],
        [16, 0, 206], [0, 0, 212], [16, 16, 213], [32, 32, 215], [48, 48, 217], [64, 64, 219], [80, 80, 221], [96, 96, 223],
        [112, 112, 225], [128, 128, 226], [144, 144, 228], [160, 160, 230], [176, 176, 232], [192, 192, 234], [208, 208, 236], [224, 224, 238],
        [240, 240, 240], [224, 224, 224], [208, 208, 208], [192, 192, 192], [176, 176, 176], [160, 160, 160], [144, 144, 144], [128, 128, 128],
        [112, 112, 112], [96, 96, 96], [80, 80, 80], [64, 64, 64], [48, 48, 48], [32, 32, 32], [16, 16, 16], [0, 0, 0]
    ],
    NTSC: [
        [255, 255, 255], [89, 43, 133], [93, 33, 95], [123, 40, 82], [154, 48, 68], [161, 61, 66], [165, 67, 65], [169, 71, 62],
        [172, 75, 58], [176, 79, 55], [180, 83, 51], [186, 102, 53], [193, 122, 54], [200, 141, 55], [207, 161, 57], [213, 181, 58],
        [220, 201, 59], [227, 221, 60], [198, 212, 56], [172, 206, 55], [147, 200, 53], [121, 195, 51], [96, 189, 49], [70, 183, 47],
        [45, 177, 45], [39, 154, 60], [33, 131, 73], [27, 108, 85], [25, 91, 101], [33, 88, 132], [41, 82, 163], [48, 75, 194],
        [28, 194, 213], [38, 195, 213], [48, 196, 213], [59, 197, 213], [69, 198, 213], [79, 199, 213], [89, 200, 213], [99, 201, 213],
        [109, 202, 213], [119, 203, 213], [129, 204, 213], [139, 205, 213], [149, 206, 213], [159, 207, 213], [169, 208, 213], [179, 209, 213],
        [177, 242, 185], [165, 240, 173], [154, 239, 161], [142, 237, 148], [130, 236, 136], [118, 234, 124], [107, 232, 112], [95, 231, 99],
        [83, 229, 87], [71, 228, 75], [59, 226, 63], [48, 224, 50], [36, 223, 38], [24, 221, 26], [12, 220, 14], [1, 218, 1],
        [1, 200, 1], [0, 187, 1], [0, 174, 1], [0, 160, 1], [0, 147, 1], [0, 133, 1], [0, 120, 0], [0, 107, 0],
        [0, 93, 0], [0, 80, 0], [0, 66, 0], [0, 53, 0], [0, 40, 0], [0, 26, 0], [0, 13, 0], [0, 0, 0],
        [10, 9, 0], [22, 21, 1], [34, 33, 2], [46, 45, 2], [58, 57, 3], [70, 68, 4], [82, 80, 5], [94, 92, 5],
        [106, 104, 6], [119, 116, 7], [131, 128, 8], [143, 139, 8], [155, 151, 9], [167, 163, 10], [179, 175, 11], [191, 187, 11],
        [197, 192, 12], [200, 196, 21], [203, 199, 29], [207, 202, 38], [210, 205, 47], [213, 208, 56], [216, 211, 65], [219, 214, 74],
        [223, 217, 82], [226, 220, 91], [229, 223, 100], [232, 226, 109], [235, 229, 118], [239, 232, 127], [242, 235, 135], [245, 238, 144],
        [217, 175, 161], [217, 169, 152], [217, 162, 143], [217, 156, 135], [217, 149, 126], [217, 143, 118], [217, 136, 109], [217, 130, 101],
        [217, 123, 92], [217, 117, 83], [217, 110, 75], [217, 104, 66], [217, 97, 58], [217, 91, 49], [217, 84, 41], [217, 78, 32],
        [217, 74, 27], [203, 69, 25], [188, 64, 23], [174, 59, 22], [159, 54, 20], [145, 49, 18], [130, 44, 16], [116, 39, 14],
        [101, 34, 12], [87, 29, 11], [72, 24, 9], [58, 19, 7], [43, 14, 5], [29, 9, 3], [14, 5, 1], [0, 0, 0],
        [0, 0, 0], [11, 0, 2], [23, 0, 4], [23, 3, 6], [34, 4, 10], [46, 6, 13], [57, 7, 16], [69, 9, 20],
        [81, 11, 23], [92, 12, 26], [104, 14, 30], [115, 15, 33], [127, 17, 37], [139, 19, 40], [150, 20, 43], [162, 22, 47],
        [162, 22, 47], [177, 11, 42], [181, 23, 53], [185, 34, 63], [189, 46, 74], [193, 57, 85], [196, 69, 96], [200, 80, 107],
        [204, 92, 118], [208, 103, 129], [212, 115, 140], [215, 126, 151], [219, 138, 162], [223, 149, 173], [227, 161, 184], [231, 173, 195],
        [201, 170, 240], [195, 161, 239], [190, 151, 237], [185, 141, 235], [179, 132, 233], [174, 122, 232], [168, 112, 230], [163, 103, 228],
        [158, 93, 227], [152, 83, 225], [147, 74, 223], [141, 64, 221], [136, 54, 220], [131, 45, 218], [125, 35, 216], [120, 25, 215],
        [117, 15, 215], [109, 14, 201], [102, 13, 188], [95, 12, 174], [87, 11, 161], [80, 10, 147], [73, 9, 134], [65, 8, 120],
        [58, 7, 107], [50, 6, 93], [43, 5, 80], [36, 4, 66], [28, 3, 53], [21, 2, 39], [14, 1, 26], [6, 0, 12],
        [0, 4, 22], [0, 6, 35], [0, 8, 48], [0, 11, 61], [0, 13, 74], [0, 16, 87], [0, 18, 100], [0, 20, 113],
        [0, 23, 126], [0, 25, 139], [0, 28, 152], [0, 30, 165], [0, 32, 178], [0, 35, 191], [0, 37, 204], [0, 39, 217],
        [0, 41, 227], [15, 54, 228], [29, 66, 229], [44, 79, 230], [59, 91, 230], [74, 103, 231], [89, 116, 232], [104, 128, 233],
        [119, 140, 233], [134, 153, 234], [149, 165, 235], [164, 178, 236], [179, 190, 236], [194, 202, 237], [209, 215, 238], [224, 227, 239],
        [240, 240, 240], [224, 224, 224], [208, 208, 208], [192, 192, 192], [176, 176, 176], [160, 160, 160], [144, 144, 144], [128, 128, 128],
        [112, 112, 112], [96, 96, 96], [80, 80, 80], [64, 64, 64], [48, 48, 48], [32, 32, 32], [16, 16, 16], [0, 0, 0]
    ],
    METALLIC: [
        [255, 255, 255], [102, 76, 128], [95, 66, 108], [88, 55, 89], [117, 71, 94], [148, 88, 99], [155, 102, 105], [159, 108, 106],
        [163, 109, 104], [166, 111, 102], [170, 115, 101], [174, 121, 103], [180, 134, 107], [187, 148, 111], [194, 162, 115], [201, 176, 119],
        [208, 190, 123], [221, 218, 131], [199, 206, 123], [182, 200, 119], [166, 195, 116], [150, 189, 112], [133, 183, 109], [118, 177, 105],
        [102, 171, 102], [88, 148, 99], [74, 125, 95], [56, 90, 95], [67, 97, 118], [78, 103, 142], [88, 109, 165], [99, 115, 188],
        [68, 42, 92], [78, 53, 102], [88, 63, 111], [98, 74, 121], [108, 85, 130], [118, 95, 140], [128, 106, 149], [138, 117, 159],
        [148, 127, 168], [158, 138, 178], [168, 148, 187], [178, 159, 196], [188, 170, 206], [198, 180, 215], [208, 191, 225], [218, 202, 234],
        [228, 212, 244], [218, 201, 234], [207, 190, 224], [196, 178, 214], [185, 167, 203], [175, 156, 193], [164, 144, 183], [153, 133, 173],
        [143, 122, 163], [132, 110, 153], [121, 99, 143], [111, 88, 133], [100, 76, 123], [89, 65, 113], [78, 54, 103], [68, 42, 92],
        [81, 32, 31], [92, 43, 43], [103, 55, 55], [114, 66, 66], [125, 77, 78], [135, 88, 89], [146, 99, 101], [157, 110, 113],
        [168, 121, 124], [179, 132, 136], [190, 144, 148], [201, 155, 159], [212, 166, 171], [223, 177, 183], [234, 188, 194], [245, 199, 206],
        [255, 210, 218], [244, 198, 205], [232, 187, 193], [221, 175, 180], [209, 163, 168], [197, 151, 155], [186, 139, 143], [174, 127, 131],
        [162, 115, 118], [151, 103, 106], [139, 92, 93], [127, 80, 81], [116, 68, 69], [104, 56, 56], [93, 44, 44], [81, 32, 31],
        [68, 38, 25], [79, 49, 34], [89, 59, 44], [100, 70, 54], [111, 81, 64], [121, 91, 73], [132, 102, 83], [142, 113, 93],
        [153, 123, 102], [164, 134, 112], [174, 145, 122], [185, 155, 131], [195, 166, 141], [206, 177, 151], [217, 187, 161], [227, 198, 170],
        [238, 209, 180], [227, 195, 165], [215, 184, 155], [204, 172, 145], [193, 161, 135], [181, 150, 125], [170, 139, 115], [159, 128, 105],
        [147, 116, 95], [136, 105, 85], [125, 94, 75], [113, 83, 65], [102, 72, 55], [91, 60, 45], [79, 49, 35], [68, 38, 25],
        [118, 85, 18], [128, 93, 28], [138, 102, 38], [147, 110, 47], [157, 119, 57], [167, 127, 67], [177, 136, 76], [187, 145, 86],
        [197, 153, 95], [206, 162, 105], [216, 170, 115], [226, 179, 124], [236, 187, 134], [246, 196, 143], [255, 204, 153], [255, 213, 171],
        [255, 225, 194], [255, 216, 177], [246, 196, 143], [236, 187, 134], [226, 179, 124], [216, 170, 115], [206, 162, 105], [197, 153, 95],
        [187, 145, 86], [177, 136, 76], [167, 127, 67], [157, 119, 57], [147, 110, 47], [138, 102, 38], [128, 93, 28], [118, 85, 18],
        [3, 48, 3], [15, 61, 15], [26, 74, 26], [38, 87, 38], [49, 100, 49], [61, 113, 61], [73, 126, 73], [84, 139, 84],
        [96, 152, 96], [107, 165, 107], [119, 178, 119], [130, 191, 131], [142, 204, 142], [154, 217, 154], [165, 230, 165], [177, 242, 177],
        [188, 255, 188], [176, 242, 176], [164, 228, 164], [151, 214, 151], [139, 200, 139], [127, 186, 127], [114, 173, 114], [102, 159, 102],
        [90, 145, 90], [77, 131, 77], [65, 117, 65], [52, 103, 53], [40, 90, 40], [28, 76, 28], [15, 62, 16], [3, 48, 3],
        [0, 15, 85], [13, 29, 96], [27, 42, 106], [41, 55, 117], [55, 69, 128], [69, 82, 138], [83, 95, 149], [97, 109, 160],
        [111, 122, 170], [125, 135, 181], [138, 149, 192], [152, 162, 202], [166, 175, 213], [180, 189, 224], [194, 202, 234], [208, 215, 245],
        [222, 229, 255], [207, 214, 244], [192, 200, 233], [177, 186, 221], [163, 172, 210], [148, 157, 199], [133, 143, 187], [118, 129, 176],
        [103, 115, 165], [88, 101, 153], [74, 86, 142], [59, 72, 131], [44, 58, 119], [29, 44, 108], [14, 30, 97], [0, 15, 85],
        [17, 17, 17], [32, 32, 32], [47, 47, 47], [62, 62, 62], [77, 77, 77], [92, 92, 92], [106, 106, 106], [121, 121, 121],
        [136, 136, 136], [151, 151, 151], [166, 166, 166], [181, 181, 181], [196, 196, 196], [211, 211, 211], [226, 226, 226], [241, 241, 241],
        [255, 255, 255], [238, 238, 238], [221, 221, 221], [204, 204, 204], [187, 187, 187], [170, 170, 170], [153, 153, 153], [136, 136, 136],
        [119, 119, 119], [102, 102, 102], [85, 85, 85], [68, 68, 68], [51, 51, 51], [34, 34, 34], [17, 17, 17], [0, 0, 0]
    ],
    VGA: [
        [0, 0, 0], [0, 0, 160], [0, 160, 0], [0, 160, 160], [160, 0, 0], [160, 0, 160], [160, 80, 0], [160, 160, 160],
        [80, 80, 80], [80, 80, 255], [80, 255, 80], [80, 255, 255], [255, 80, 80], [255, 80, 255], [255, 255, 80], [255, 255, 255],
        [0, 0, 0], [20, 20, 20], [32, 32, 32], [44, 44, 44], [56, 56, 56], [68, 68, 68], [80, 80, 80], [96, 96, 96],
        [112, 112, 112], [128, 128, 128], [144, 144, 144], [160, 160, 160], [180, 180, 180], [200, 200, 200], [224, 224, 224], [255, 255, 255],
        [0, 0, 255], [64, 0, 255], [128, 0, 255], [192, 0, 255], [255, 0, 255], [255, 0, 192], [255, 0, 128], [255, 0, 64],
        [255, 0, 0], [255, 64, 0], [255, 128, 0], [255, 192, 0], [255, 255, 0], [192, 255, 0], [128, 255, 0], [64, 255, 0],
        [0, 255, 0], [0, 255, 64], [0, 255, 128], [0, 255, 192], [0, 255, 255], [0, 192, 255], [0, 128, 255], [0, 64, 255],
        [128, 128, 255], [159, 128, 255], [192, 128, 255], [224, 128, 255], [255, 128, 255], [255, 128, 224], [255, 128, 192], [255, 128, 159],
        [255, 128, 128], [255, 159, 128], [255, 192, 128], [255, 224, 128], [255, 255, 128], [224, 255, 128], [192, 255, 128], [159, 255, 128],
        [128, 255, 128], [128, 255, 159], [128, 255, 192], [128, 255, 224], [128, 255, 255], [128, 224, 255], [128, 192, 255], [128, 159, 255],
        [180, 180, 255], [198, 180, 255], [218, 180, 255], [236, 180, 255], [255, 180, 255], [255, 180, 236], [255, 180, 218], [255, 180, 198],
        [255, 180, 180], [255, 198, 180], [255, 218, 180], [255, 236, 180], [255, 255, 180], [236, 255, 180], [218, 255, 180], [198, 255, 180],
        [180, 255, 180], [180, 255, 198], [180, 255, 218], [180, 255, 236], [180, 255, 255], [180, 236, 255], [180, 218, 255], [180, 198, 255],
        [0, 0, 112], [28, 0, 112], [56, 0, 112], [84, 0, 112], [112, 0, 112], [112, 0, 84], [112, 0, 56], [112, 0, 28],
        [112, 0, 0], [112, 28, 0], [112, 56, 0], [112, 84, 0], [112, 112, 0], [84, 112, 0], [56, 112, 0], [28, 112, 0],
        [0, 112, 0], [0, 112, 28], [0, 112, 56], [0, 112, 84], [0, 112, 112], [0, 84, 112], [0, 56, 112], [0, 28, 112],
        [56, 56, 112], [68, 56, 112], [84, 56, 112], [96, 56, 112], [112, 56, 112], [112, 56, 96], [112, 56, 84], [112, 56, 68],
        [112, 56, 56], [112, 68, 56], [112, 84, 56], [112, 96, 56], [112, 112, 56], [96, 112, 56], [84, 112, 56], [68, 112, 56],
        [56, 112, 56], [56, 112, 68], [56, 112, 84], [56, 112, 96], [56, 112, 112], [56, 96, 112], [56, 84, 112], [56, 68, 112],
        [80, 80, 112], [88, 80, 112], [96, 80, 112], [104, 80, 112], [112, 80, 112], [112, 80, 104], [112, 80, 96], [112, 80, 88],
        [112, 80, 80], [112, 88, 80], [112, 96, 80], [112, 104, 80], [112, 112, 80], [104, 112, 80], [96, 112, 80], [88, 112, 80],
        [80, 112, 80], [80, 112, 88], [80, 112, 96], [80, 112, 104], [80, 112, 112], [80, 104, 112], [80, 96, 112], [80, 88, 112],
        [0, 0, 64], [16, 0, 64], [32, 0, 64], [48, 0, 64], [64, 0, 64], [64, 0, 48], [64, 0, 32], [64, 0, 16],
        [64, 0, 0], [64, 16, 0], [64, 32, 0], [64, 48, 0], [64, 64, 0], [48, 64, 0], [32, 64, 0], [16, 64, 0],
        [0, 64, 0], [0, 64, 16], [0, 64, 32], [0, 64, 48], [0, 64, 64], [0, 48, 64], [0, 32, 64], [0, 16, 64],
        [32, 32, 64], [40, 32, 64], [48, 32, 64], [56, 32, 64], [64, 32, 64], [64, 32, 56], [64, 32, 48], [64, 32, 40],
        [64, 32, 32], [64, 40, 32], [64, 48, 32], [64, 56, 32], [64, 64, 32], [56, 64, 32], [48, 64, 32], [40, 64, 32],
        [32, 64, 32], [32, 64, 40], [32, 64, 48], [32, 64, 56], [32, 64, 64], [32, 56, 64], [32, 48, 64], [32, 40, 64],
        [44, 44, 64], [48, 44, 64], [52, 44, 64], [60, 44, 64], [64, 44, 64], [64, 44, 60], [64, 44, 52], [64, 44, 48],
        [64, 44, 44], [64, 48, 44], [64, 52, 44], [64, 60, 44], [64, 64, 44], [60, 64, 44], [52, 64, 44], [48, 64, 44],
        [44, 64, 44], [44, 64, 48], [44, 64, 52], [44, 64, 60], [44, 64, 64], [44, 60, 64], [44, 52, 64], [44, 48, 64],
        [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]
    ],
    WIN_D5: [
        [255, 255, 255], [0, 255, 255], [255, 0, 255], [0, 0, 255], [255, 255, 0], [0, 255, 0], [255, 0, 0], [128, 128, 128],
        [160, 160, 164], [255, 251, 240], [51, 51, 51], [153, 102, 0], [51, 102, 51], [0, 51, 153], [204, 0, 255], [136, 0, 0],
        [255, 204, 102], [255, 153, 204], [221, 221, 221], [255, 153, 0], [255, 102, 255], [255, 102, 204], [255, 102, 153], [255, 102, 102],
        [255, 102, 51], [255, 102, 0], [255, 51, 255], [255, 51, 204], [255, 51, 153], [255, 51, 102], [255, 51, 51], [255, 51, 0],
        [255, 0, 204], [255, 0, 153], [255, 0, 102], [255, 0, 51], [204, 255, 255], [204, 255, 204], [204, 255, 153], [204, 255, 102],
        [204, 255, 51], [204, 255, 0], [204, 204, 255], [204, 204, 204], [204, 204, 153], [204, 204, 102], [204, 204, 51], [204, 204, 0],
        [204, 153, 255], [204, 153, 204], [204, 153, 153], [204, 153, 102], [204, 153, 51], [204, 153, 0], [204, 102, 255], [204, 102, 204],
        [204, 102, 153], [204, 102, 102], [204, 102, 51], [204, 102, 0], [204, 51, 255], [204, 51, 204], [204, 51, 153], [204, 51, 102],
        [204, 51, 51], [204, 51, 0], [212, 8, 255], [204, 0, 204], [204, 0, 153], [204, 0, 102], [204, 0, 51], [204, 0, 0],
        [153, 255, 255], [153, 255, 204], [153, 255, 153], [153, 255, 102], [153, 255, 51], [153, 255, 0], [153, 204, 255], [153, 204, 204],
        [153, 204, 153], [153, 204, 102], [153, 204, 51], [153, 204, 0], [153, 153, 255], [153, 153, 204], [153, 153, 153], [153, 153, 102],
        [153, 153, 51], [153, 153, 0], [153, 102, 255], [153, 102, 204], [153, 102, 153], [153, 102, 102], [153, 102, 51], [161, 102, 0],
        [153, 51, 255], [153, 51, 204], [153, 51, 153], [153, 51, 102], [153, 51, 51], [153, 51, 0], [153, 0, 255], [153, 0, 204],
        [153, 0, 153], [153, 0, 102], [153, 0, 51], [153, 0, 0], [102, 255, 255], [102, 255, 204], [102, 255, 153], [102, 255, 102],
        [102, 255, 51], [102, 255, 0], [102, 204, 255], [102, 204, 204], [102, 204, 153], [102, 204, 102], [102, 204, 51], [102, 204, 0],
        [102, 153, 255], [102, 153, 204], [102, 153, 153], [102, 153, 102], [102, 153, 51], [102, 153, 0], [102, 102, 255], [102, 102, 204],
        [102, 102, 153], [102, 102, 102], [102, 102, 51], [102, 102, 0], [102, 51, 255], [102, 51, 204], [102, 51, 153], [102, 51, 102],
        [102, 51, 51], [102, 51, 0], [102, 0, 255], [102, 0, 204], [102, 0, 153], [102, 0, 102], [102, 0, 51], [102, 0, 0],
        [51, 255, 255], [51, 255, 204], [51, 255, 153], [51, 255, 102], [51, 255, 51], [51, 255, 0], [51, 204, 255], [51, 204, 204],
        [51, 204, 153], [51, 204, 102], [51, 204, 51], [51, 204, 0], [51, 153, 255], [51, 153, 204], [51, 153, 153], [51, 153, 102],
        [51, 153, 51], [51, 153, 0], [51, 102, 255], [51, 102, 204], [51, 102, 153], [51, 102, 102], [51, 110, 51], [51, 102, 0],
        [51, 51, 255], [51, 51, 204], [51, 51, 153], [51, 51, 102], [51, 51, 59], [51, 51, 0], [51, 0, 255], [51, 0, 204],
        [51, 0, 153], [51, 0, 102], [51, 0, 51], [51, 0, 0], [0, 255, 204], [0, 255, 153], [0, 255, 102], [0, 255, 51],
        [0, 204, 255], [0, 204, 204], [0, 204, 153], [0, 204, 102], [0, 204, 51], [0, 204, 0], [0, 153, 255], [0, 153, 204],
        [0, 153, 153], [0, 153, 102], [0, 153, 51], [0, 153, 0], [0, 102, 255], [0, 102, 204], [0, 102, 153], [0, 102, 102],
        [0, 102, 51], [0, 102, 0], [0, 51, 255], [0, 51, 204], [0, 51, 161], [0, 51, 102], [0, 51, 51], [0, 51, 0],
        [0, 0, 204], [0, 0, 153], [0, 0, 102], [0, 0, 51], [238, 0, 0], [221, 0, 0], [170, 0, 0], [144, 0, 0],
        [119, 0, 0], [85, 0, 0], [68, 0, 0], [34, 0, 0], [17, 0, 0], [0, 238, 0], [0, 221, 0], [0, 170, 0],
        [0, 136, 0], [0, 119, 0], [0, 85, 0], [0, 68, 0], [0, 34, 0], [0, 17, 0], [0, 0, 238], [0, 0, 221],
        [0, 0, 170], [0, 0, 136], [0, 0, 119], [0, 0, 85], [0, 0, 68], [0, 0, 34], [0, 0, 17], [34, 34, 48],
        [255, 153, 153], [255, 204, 255], [153, 212, 255], [153, 212, 153], [255, 255, 153], [240, 240, 240], [166, 200, 240], [192, 220, 192],
        [192, 192, 192], [0, 128, 128], [128, 0, 128], [0, 0, 128], [128, 128, 0], [0, 128, 0], [128, 0, 0], [0, 0, 0]
    ],
    WEB_216: [
        [0, 0, 0], [0, 0, 51], [0, 0, 102], [0, 0, 153], [0, 0, 204], [0, 0, 255], [0, 51, 0], [0, 51, 51],
        [0, 51, 102], [0, 51, 153], [0, 51, 204], [0, 51, 255], [0, 102, 0], [0, 102, 51], [0, 102, 102], [0, 102, 153],
        [0, 102, 204], [0, 102, 255], [0, 153, 0], [0, 153, 51], [0, 153, 102], [0, 153, 153], [0, 153, 204], [0, 153, 255],
        [0, 204, 0], [0, 204, 51], [0, 204, 102], [0, 204, 153], [0, 204, 204], [0, 204, 255], [0, 255, 0], [0, 255, 51],
        [0, 255, 102], [0, 255, 153], [0, 255, 204], [0, 255, 255], [51, 0, 0], [51, 0, 51], [51, 0, 102], [51, 0, 153],
        [51, 0, 204], [51, 0, 255], [51, 51, 0], [51, 51, 51], [51, 51, 102], [51, 51, 153], [51, 51, 204], [51, 51, 255],
        [51, 102, 0], [51, 102, 51], [51, 102, 102], [51, 102, 153], [51, 102, 204], [51, 102, 255], [51, 153, 0], [51, 153, 51],
        [51, 153, 102], [51, 153, 153], [51, 153, 204], [51, 153, 255], [51, 204, 0], [51, 204, 51], [51, 204, 102], [51, 204, 153],
        [51, 204, 204], [51, 204, 255], [51, 255, 0], [51, 255, 51], [51, 255, 102], [51, 255, 153], [51, 255, 204], [51, 255, 255],
        [102, 0, 0], [102, 0, 51], [102, 0, 102], [102, 0, 153], [102, 0, 204], [102, 0, 255], [102, 51, 0], [102, 51, 51],
        [102, 51, 102], [102, 51, 153], [102, 51, 204], [102, 51, 255], [102, 102, 0], [102, 102, 51], [102, 102, 102], [102, 102, 153],
        [102, 102, 204], [102, 102, 255], [102, 153, 0], [102, 153, 51], [102, 153, 102], [102, 153, 153], [102, 153, 204], [102, 153, 255],
        [102, 204, 0], [102, 204, 51], [102, 204, 102], [102, 204, 153], [102, 204, 204], [102, 204, 255], [102, 255, 0], [102, 255, 51],
        [102, 255, 102], [102, 255, 153], [102, 255, 204], [102, 255, 255], [153, 0, 0], [153, 0, 51], [153, 0, 102], [153, 0, 153],
        [153, 0, 204], [153, 0, 255], [153, 51, 0], [153, 51, 51], [153, 51, 102], [153, 51, 153], [153, 51, 204], [153, 51, 255],
        [153, 102, 0], [153, 102, 51], [153, 102, 102], [153, 102, 153], [153, 102, 204], [153, 102, 255], [153, 153, 0], [153, 153, 51],
        [153, 153, 102], [153, 153, 153], [153, 153, 204], [153, 153, 255], [153, 204, 0], [153, 204, 51], [153, 204, 102], [153, 204, 153],
        [153, 204, 204], [153, 204, 255], [153, 255, 0], [153, 255, 51], [153, 255, 102], [153, 255, 153], [153, 255, 204], [153, 255, 255],
        [204, 0, 0], [204, 0, 51], [204, 0, 102], [204, 0, 153], [204, 0, 204], [204, 0, 255], [204, 51, 0], [204, 51, 51],
        [204, 51, 102], [204, 51, 153], [204, 51, 204], [204, 51, 255], [204, 102, 0], [204, 102, 51], [204, 102, 102], [204, 102, 153],
        [204, 102, 204], [204, 102, 255], [204, 153, 0], [204, 153, 51], [204, 153, 102], [204, 153, 153], [204, 153, 204], [204, 153, 255],
        [204, 204, 0], [204, 204, 51], [204, 204, 102], [204, 204, 153], [204, 204, 204], [204, 204, 255], [204, 255, 0], [204, 255, 51],
        [204, 255, 102], [204, 255, 153], [204, 255, 204], [204, 255, 255], [255, 0, 0], [255, 0, 51], [255, 0, 102], [255, 0, 153],
        [255, 0, 204], [255, 0, 255], [255, 51, 0], [255, 51, 51], [255, 51, 102], [255, 51, 153], [255, 51, 204], [255, 51, 255],
        [255, 102, 0], [255, 102, 51], [255, 102, 102], [255, 102, 153], [255, 102, 204], [255, 102, 255], [255, 153, 0], [255, 153, 51],
        [255, 153, 102], [255, 153, 153], [255, 153, 204], [255, 153, 255], [255, 204, 0], [255, 204, 51], [255, 204, 102], [255, 204, 153],
        [255, 204, 204], [255, 204, 255], [255, 255, 0], [255, 255, 51], [255, 255, 102], [255, 255, 153], [255, 255, 204], [255, 255, 255],
        [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0],
        [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0],
        [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0],
        [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0],
        [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0], [0, 0, 0]
    ],
    GRAY_FIXED: Array.from({ length: 256 }, (_, i) => [255 - i, 255 - i, 255 - i])
};

class Palette {
    /**
     * Parses a raw CLUT palette. Supports multiple formats:
     * - 768 bytes: 8-bit RGB (3 bytes per entry)
     * - 1024 bytes: 8-bit RGB + Alpha/Skip (4 bytes per entry)
     * - 1536 bytes: 16-bit RGB (6 bytes per entry, divide by 256)
     */
    static parseDirector(buffer) {
        if (!buffer) return PALETTES.MAC;

        const palette = [];
        const len = buffer.length;

        if (len >= 1536) { // 16-bit RGB (6 bytes per entry)
            for (let i = 0; i < 256; i++) {
                const offset = i * 6;
                const r = buffer.readUInt16BE(offset);
                const g = buffer.readUInt16BE(offset + 2);
                const b = buffer.readUInt16BE(offset + 4);
                palette.push([r >> 8, g >> 8, b >> 8]);
            }
        } else if (len >= 1024) { // 8-bit RGB + Skip (4 bytes per entry)
            for (let i = 0; i < 256; i++) {
                const offset = i * 4;
                palette.push([buffer[offset], buffer[offset + 1], buffer[offset + 2]]);
            }
        } else if (len >= 768) { // 8-bit RGB (3 bytes per entry)
            for (let i = 0; i < 256; i++) {
                const offset = i * 3;
                palette.push([buffer[offset], buffer[offset + 1], buffer[offset + 2]]);
            }
        } else {
            return PALETTES.MAC;
        }

        return palette;
    }

    static getMacSystem7() { return PALETTES.MAC; }
    static getWindowsSystem() { return PALETTES.WIN; }
    static getGrayscale() { return PALETTES.GRAYSCALE; }

    /**
     * Standard Director System Palette IDs
     */
    static get SystemPalette() {
        return {
            // Negative Resource IDs
            MAC_SYSTEM: -1,
            RAINBOW: -2,
            GRAYSCALE: -3,
            PASTELS: -4,
            VIVID: -5,
            NTSC: -6,
            METALLIC: -7,
            WEB_216: -8,
            VGA: -9,
            WINDOWS_SYSTEM: -101,
            WINDOWS_SYSTEM_D5: -102,

            // Positive Logical IDs (1-based CASt/ILS indices)
            LOGICAL_MAC: 1,
            LOGICAL_RAINBOW: 2,
            LOGICAL_GRAYSCALE: 3,
            LOGICAL_PASTELS: 4,
            LOGICAL_VIVID: 5,
            LOGICAL_NTSC: 6,
            LOGICAL_METALLIC: 7,
            LOGICAL_VGA: 8,
            LOGICAL_WEB216: 9,
            LOGICAL_WIN: 10,
            LOGICAL_NTSC_30: 30
        };
    }

    /**
     * Gets a system palette by Director's internal ID.
     * @param {number} id 
     * @param {string} platform 
     * @returns {Array|null}
     */
    static getSystemPaletteById(id, platform = 'Macintosh') {
        const sys = this.SystemPalette;

        // Handle positive logical IDs (1-based) as used in CASt chunk
        if (id > 0) {
            switch (id) {
                case sys.LOGICAL_MAC: return PALETTES.MAC;
                case sys.LOGICAL_RAINBOW: return PALETTES.RAINBOW;
                case sys.LOGICAL_GRAYSCALE: return PALETTES.GRAYSCALE;
                case sys.LOGICAL_PASTELS: return PALETTES.PASTELS;
                case sys.LOGICAL_VIVID: return PALETTES.VIVID;
                case sys.LOGICAL_NTSC: return PALETTES.NTSC;
                case sys.LOGICAL_METALLIC: return PALETTES.METALLIC;
                case sys.LOGICAL_VGA: return PALETTES.VGA;
                case sys.LOGICAL_WEB216: return PALETTES.WEB_216;
                case sys.LOGICAL_WIN: return PALETTES.WIN;
                case sys.LOGICAL_NTSC_30: return PALETTES.NTSC;
                default: return null;
            }
        }

        // Handle negative resource IDs
        switch (id) {
            case sys.MAC_SYSTEM: return PALETTES.MAC;
            case sys.RAINBOW: return PALETTES.RAINBOW;
            case sys.GRAYSCALE: return PALETTES.GRAYSCALE;
            case sys.PASTELS: return PALETTES.PASTELS;
            case sys.VIVID: return PALETTES.VIVID;
            case sys.NTSC: return PALETTES.NTSC;
            case sys.METALLIC: return PALETTES.METALLIC;
            case sys.WEB_216: return PALETTES.WEB_216;
            case sys.VGA: return PALETTES.VGA;
            case sys.WINDOWS_SYSTEM: return PALETTES.WIN;
            case sys.WINDOWS_SYSTEM_D5: return PALETTES.WIN_D5;
            case 0: // Default Movie Palette / Current System
                return (platform === 'Windows') ? PALETTES.WIN : PALETTES.MAC;
            case -1: // Explicit Mac System
                return PALETTES.MAC;
            default:
                return null;
        }
    }

    /**
     * Fundamentals: Traces the palette reference chain across members (borrowing).
     */
    static async tracePaletteChain(member, extractor, platform, visited = new Set()) {
        if (visited.has(member.id)) return null;
        visited.add(member.id);
        if (visited.size > 10) return null;

        const hasModernBit = (member._castFlags & 0x20) !== 0;
        let linkId = (hasModernBit && member.secondaryPaletteId) ? member.secondaryPaletteId : member.paletteId;

        // 1. No Palette reference
        if (linkId === 0 || linkId === -1 || !linkId) return null;

        // 2. Negative IDs are explicit System Palettes
        if (linkId < 0) {
            const sysPal = this.getSystemPaletteById(linkId, platform);
            if (sysPal) {
                const sysName = this.getSystemPaletteName(linkId) || "System";
                member.palette = { id: linkId, name: sysName, castlib: 'system', traced: true };
                return sysPal;
            }
            return null;
        }

        // --- NEW: ILS/Logical Resolution ---
        // For D4+, linkId is often an index into the Initial Load Segment (ILS)
        const resolvedId = (extractor && extractor.metadataManager) ? extractor.metadataManager.resolvePaletteId(linkId) : null;
        const searchId = resolvedId || linkId;

        // 3. Local Member Check (Use resolved searchId)
        if (extractor && extractor.members) {
            const target = extractor.members.find(m => m.id === searchId);
            if (target) {
                if (target.typeId === 4 || target.type === 'Palette' || target.format === 'pal') {
                    const data = target.palette?.data || target.palette || target.data;
                    const pal = data ? (Array.isArray(data) ? data : this.parseDirector(data)) : null;
                    if (pal) {
                        member.palette = { id: target.id, name: target.name, castlib: 'internal', traced: true, resolution: (resolvedId ? 'ils' : 'direct') };
                        return pal;
                    }
                } else if (target.typeId === 1 || target.type === 'Bitmap') {
                    const borrowedPal = await this.tracePaletteChain(target, extractor, platform, visited);
                    if (borrowedPal) {
                        member.palette = Object.assign({}, target.palette, { traced: true, borrowedFrom: target.name });
                        return borrowedPal;
                    }
                }
            }
        }

        // 4. Legacy Cast Slot Mapping (General Heuristic)
        // If linkId is a positive integer (e.g. 8) and wasn't found as a direct Member ID,
        // it likely refers to a Cast Slot Index (MCsL or Implicit Key Order).
        if (linkId > 0 && extractor) {
            let slotValue = undefined;

            // Try explicit MCsL first
            if (extractor.castOrder && extractor.castOrder[linkId] !== undefined) {
                slotValue = extractor.castOrder[linkId];
            }
            // Fallback to implicit Key Table order
            else if (extractor.metadataManager && extractor.metadataManager.castList && extractor.metadataManager.castList[linkId] !== undefined) {
                slotValue = extractor.metadataManager.castList[linkId];
            }

            if (slotValue !== undefined) {
                // The slot contains a value (e.g. 20). 
                // We need to find the member that corresponds to this value (Internal ID or Cast ID).
                // MetadataManager parses 'originalSlotId' from CASt chunks (Internal ID).
                // Sometimes the slotValue IS the Member ID directly (if no aliasing).

                if (extractor.members) {
                    // Try linking via Internal ID (Aliasing)
                    let target = extractor.members.find(m => m.originalSlotId === slotValue && (m.type === 'Palette' || m.typeId === 4));

                    // If not found via internal ID, try direct ID match (if slotValue is a valid Member ID)
                    if (!target) {
                        target = extractor.members.find(m => m.id === slotValue && (m.type === 'Palette' || m.typeId === 4));
                    }

                    if (target) {
                        // Found it!
                        const data = target.palette?.data || target.palette || target.data;
                        const pal = data ? (Array.isArray(data) ? data : this.parseDirector(data)) : null;
                        if (pal) {
                            member.palette = { id: target.id, name: target.name, castlib: 'internal', traced: true, resolution: 'slot-lookup' };
                            return pal;
                        }
                    }
                }
            }
        }

        // 5. Cross-Cast Reference (Project Context)
        if (extractor && extractor.projectContext) {
            const externalMember = await extractor.projectContext.getMember(linkId);
            if (externalMember) {
                if (externalMember.typeId === 4 || externalMember.type === 'Palette' || externalMember.format === 'pal') {
                    const data = externalMember.palette?.data || externalMember.palette || externalMember.data;
                    const pal = data ? (Array.isArray(data) ? data : this.parseDirector(data)) : null;
                    if (pal) {
                        member.palette = { id: externalMember.id, name: externalMember.name, castlib: externalMember.castlibName, traced: true, resolution: 'cross-cast' };
                        return pal;
                    }
                } else if (externalMember.typeId === 1 || externalMember.type === 'Bitmap') {
                    const borrowedPal = await this.tracePaletteChain(externalMember, extractor, platform, visited);
                    if (borrowedPal) {
                        member.palette = Object.assign({}, externalMember.palette, { traced: true, borrowedFrom: externalMember.name });
                        return borrowedPal;
                    }
                }
            }
        }
        return null;
    }

    static getSystemPaletteName(id) {
        const sys = this.SystemPalette;
        const names = {
            [sys.MAC_SYSTEM]: "SystemMac",
            [sys.LOGICAL_MAC]: "SystemMac",
            [sys.RAINBOW]: "Rainbow",
            [sys.LOGICAL_RAINBOW]: "Rainbow",
            [sys.GRAYSCALE]: "Grayscale",
            [sys.LOGICAL_GRAYSCALE]: "Grayscale",
            [sys.PASTELS]: "Pastels",
            [sys.LOGICAL_PASTELS]: "Pastels",
            [sys.VIVID]: "Vivid",
            [sys.LOGICAL_VIVID]: "Vivid",
            [sys.NTSC]: "NTSC",
            [sys.LOGICAL_NTSC]: "NTSC",
            [sys.METALLIC]: "Metallic",
            [sys.LOGICAL_METALLIC]: "Metallic",
            [sys.WEB_216]: "WebSafe216",
            [sys.LOGICAL_WEB216]: "WebSafe216",
            [sys.VGA]: "VGA",
            [sys.LOGICAL_VGA]: "VGA",
            [sys.WINDOWS_SYSTEM]: "SystemWin",
            [sys.LOGICAL_WIN]: "SystemWin",
            [sys.WINDOWS_SYSTEM_D5]: "SystemWinD5"
        };
        return names[id] || null;
    }

    /**
     * Resolves a palette index to a hex color string.
     * @param {number} index 
     * @param {Array} palette 
     */
    static resolve(index, palette = null) {
        const pal = palette || PALETTES.MAC;
        const rgb = (index >= 0 && index < pal.length) ? pal[index] : [0, 0, 0];
        return this.toHex(rgb);
    }

    /**
     * Converts RGB array to standardized Hex string.
     */
    static toHex(rgb) {
        if (!rgb || rgb.length < 3) return '#000000';
        return '#' + rgb.map(c => c.toString(16).padStart(2, '0')).join('');
    }

    /**
     * Resolves the correct palette for a member based on its properties and project context.
     * Logic moved from PaletteResolver.js
     */
    static async resolveMemberPalette(member, extractor) {
        const { name, platform } = member;

        // --- FUNDAMENTAL -1: 1-bit Override ---
        // 1-bit images in Director are strictly Black/White (Mac System).
        // They should ignore any assigned palette ID.
        if (member.bitDepth === 1) {
            return PALETTES.MAC;
        }

        // --- FUNDAMENTAL 0: Logical ID Conversion ---
        let logicalPaletteId = member.paletteId;
        const hasModernBit = (member._castFlags & 0x20) !== 0;

        // If modern bit is set and we have a secondary ID, use it
        if (hasModernBit && member.secondaryPaletteId) {
            logicalPaletteId = member.secondaryPaletteId;
        }

        // --- FUNDAMENTAL 1: Movie Default Palette ---
        // If paletteId is 0, we should use the movie's default palette from DRCF
        if ((logicalPaletteId === 0 || logicalPaletteId === -1) && extractor?.metadataManager?.movieConfig?.defaultPaletteId) {
            logicalPaletteId = extractor.metadataManager.movieConfig.defaultPaletteId;
        }

        // --- FUNDAMENTAL 2: Trace Reference Chains ---
        const tracedPal = await this.tracePaletteChain(member, extractor, platform);
        if (tracedPal) return tracedPal;

        // --- LEGACY HEURISTICS START ---
        const isInternalPriority = !hasModernBit || member._compression !== 0;

        // Standard System IDs - Check this early if tracing failed
        // [MODIFIED] Commented out. Positive IDs should only be System if they were in LCTX.
        // Otherwise, they are Cast Member IDs. If missing, fall to heuristics.
        /*
        if (logicalPaletteId > 0 && logicalPaletteId <= 100) {
            const sys = this.getSystemPaletteById(logicalPaletteId, platform);
            if (sys) {
                member.palette = { id: logicalPaletteId, name: this.getSystemPaletteName(logicalPaletteId), castlib: 'system' };
                return sys;
            }
        }
        */

        // Contextual Search (Generic Filter: Preceding Palette in same cast)
        if (isInternalPriority && extractor.members) {
            const pals = extractor.members.filter(m => m.typeId === 4);
            const preceding = pals.filter(m => m.id < member.id).sort((a, b) => b.id - a.id);
            let internalPal = (preceding.length > 0) ? preceding[0] : null;

            if (internalPal) {
                const palData = internalPal.palette ? (internalPal.palette.data || internalPal.palette) : null;
                const pal = palData ? this.parseDirector(palData) : null;
                if (pal) {
                    member.palette = { id: internalPal.id, name: internalPal.name, castlib: 'internal', heuristic: 'preceding' };
                    return pal;
                }
            }
        }

        // Ultimate Fallback
        const defaultId = (platform === 'Windows' ? -101 : -1);
        member.palette = { id: defaultId, name: "System Fallback", castlib: 'system', fallback: true };
        return this.getSystemPaletteById(defaultId, platform);
    }
}

module.exports = {
    Palette,
    PALETTES
};
